<!--
#
#
-->
# An Example of How to Encrypt Your Log Messages

The following content walks you through how to encrypt log messages generated by your container workload deployed within an **IBM Cloud Hyper Protect Virtual Server for VPC** instance. This virtual server instance is provisioned using an [IBM Hyper Protect Container Runtime (HPCR) image](https://cloud.ibm.com/docs/vpc?topic=vpc-vsabout-images#hyper-protect-runtime)
<br />
## Background
Hyper Protect Virtual Servers for VPC is based on a newly introduced [encrypted contract](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se) concept. A valid contract is required for creating an instance. A section of the contract stores your logging configuration( Find out more [here](https://cloud.ibm.com/docs/vpc?topic=vpc-logging-for-hyper-protect-virtual-servers-for-vpc)). The logs produced within your deployed workload are sent via TLS to the [Log Analysis instance](https://cloud.ibm.com/docs/vpc?topic=vpc-logging-for-hyper-protect-virtual-servers-for-vpc) you provisioned and later displayed on the Log Analysis dashboard.
While the data in transit is encrypted, they will show up as plain text on the Log Analysis dashboard. In case your containerised workload produces sensitive information, this tutorial show you how to let the dashboard display the ciphered text of your selected log messages. To retrieve the deciphered messages, you can download the logs from your Log Analysis instance and decrypt it following the instructions in this tutorial.
<br />
## Introduction
This tutorial deploys a Docker container as a **IBM Cloud Hyper Protect Virtual Server for VPC**. Inside the `/example-files` folder, you can find the following materials:
1. A `docker-compose.yaml` file under `/compose` directory, which deploys and manages the container application we use in this tutorial. The image we use is the official Ubuntu image from [DockerHub](https://hub.docker.com/_/ubuntu).
2. Within the Docker Compose file, there is a `command: ` instruction to tell Docker to run a Shell script that prints a line of plain text, as well as a line of encrypted message to the standard output. This `example.sh` file exists in the `/compose/bin` directory.
3. A public key `logging.pub` is required for encrypting the log message. This file must exist in the `/compose` folder. This tutorial will show an example generating a key pair encrypted via AES with a passphrase using openssl.
4. The `volumes: ` instruction tells Docker to mount the `compose` volume with the public key and the simple logging application to `/var/logging` inside the container. The Ubuntu image will later start as a container and run `example.sh` as its main application.

The [contract](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se) is a YAML file to specify the Hyper Protect Virtual Servers for VPC instance you want to create. In this tutorial, a dedicated public/private keypair is used to encrypt/decrypt the selected log messages. The private key is kept by you to later decrypt the downloaded logs. The public key must be embedded into the contract, which is a special approach for our case.


The public key `logging.pub` is stored under the `/example-files` folder along with the `docker-compose.yml` file. As mentioned in the [`workload` section](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se#hpcr_contract_workload) of contract preparation, the `archive` subsection contains `base64` encoded TGZ file archive of `docker-compose.yml`. The `logging.pub` file in our example will undergo the same encoding and compression since it is stored in the same folder. As a result, the created VSI will acquire the public key for subsequent log encryption.

This tutorial also provides sample files such as `env.yaml`, `workload.yaml` and `user-data.yaml`. They are only meant as references for correct schema.
<br />
## Prerequisite
1. Install [OpenSSL](https://www.openssl.org/) for encryption, this tutorial uses version 3.0 or later
2. Set up your logging instance by following the [guide](https://cloud.ibm.com/docs/vpc?topic=vpc-logging-for-hyper-protect-virtual-servers-for-vpc)
3. This provided example runs on a Linux system
<br />
## Prepare Your Contract
This tutorial will get you started with a simple Hyper Protect Virtual Servers for VPC contract that only has an [`env` section](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se#hpcr_contract_env) and a [`workload` section](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se#hpcr_contract_workload).
As recommended by the [product guide](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se#hpcr_contract_encrypt), we will encrypt both sections. When the Hyper Protect Virtual Servers for VPC instance boots, the bootloader decrypts the contract if it is encrypted. Download the certificate that is used to encrypt the contract [here](https://cloud.ibm.com/media/docs/downloads/hyper-protect-container-runtime/ibm-hyper-protect-container-runtime-1-0-s390x-8-encrypt.crt). By the time this tutorial was written, the latest version of the IBM Hyper Protect Container Runtime image version was `ibm-hyper-protect-container-runtime-1-0-s390x-8`, thus this example uses the certificate for this image. The file `hpcr.crt` is already available inside `example-files`. Please follow the steps below to obtain the simple contract.
 1. Get the hostname and the ingestion key of your logging instance, see [Logging for Hyper Protect Virtual Servers for VPC](https://cloud.ibm.com/docs/vpc?topic=vpc-logging-for-hyper-protect-virtual-servers-for-vpc).
 2. Create and encrypt the `env` section. Please refer to the `env.yaml` file in the `example-files` folder, replace the content with your logging hostname and ingestion key. Run the `encrypt-basic.sh` script to obtain the encrypted `env` section of the contract.
   ```
           cat env.yaml | ./encrypt-basic.sh hpcr.crt
   ```
 3. Create the `workload` section. Please refer to the `workload.yaml` sample file in the `example-files` folder. In this example, the docker compose file in the `example-files` folder will be used for the `compose` subsection.
 ***In addition, please provide the public key for encrypting the log messages.***
 Run the following commands to generate a key pair, we will proceed with the public key ( please note that `logEncrypt` is the passphrase to generate keys, you may use your own).
   ```
           openssl genrsa -aes128 -passout pass:logEncrypt -out logging 4096
   ```
   ```
           openssl rsa -in logging -passin pass:logEncrypt -pubout -out logging.pub
   ```
  4. A sample output can be found in the `compose` folder under `example-files`. Keep in mind that the `logging.pub` file containing the public key must lie within the `compose` folder along with `docker-compose.yml`.

     We then go on the compress and encrypt the folder, as the `compose` subsection requires this for the `archive` value. Use the followin command to obtain the `base64` encoded archive as a file named `compose.b64`. Use the raw content of `compose.b64` for the value of `archive` under the `compose` subsection.
   ```
           tar czvf - -C <COMPOSE_FOLDER> . | base64 -w0 > compose.b64
   ```
  5. Run the `encrypt-basic.sh` script to obtain the encrypted `workload` section of the contract.
   ```
           cat workload.yaml | ./encrypt-basic.sh hpcr.crt
   ```
  6. Complete the `user-data.yaml` with the output of of Step 2 and 5. Please refer to the sample `user-data.yaml` for correct schema. Please note the `hyper-protect-basic` token approach to implement hybrid encryption, as it is used throughout **IBM Cloud Hyper Protect Virtual Server for VPC**
<br />
## Create your Virtual Server Instance
With the User Data available, we go ahead to create an instance. The quickest way is to use the [UI](https://cloud.ibm.com/docs/vpc?topic=vpc-creating-virtual-servers&interface=ui). For the Operating system, choose [**IBM Hyper Protect**](https://cloud.ibm.com/docs/vpc?topic=vpc-vsabout-images#hyper-protect-runtime) to create an **IBM Cloud® Hyper Protect Virtual Server for IBM Cloud® Virtual Private Cloud instance**. Remember to paste your User Data in the `User data` box. Click **Create virtual server instance** when you are ready. Next, monitor the Serial Console, go to the logging instance you provisioned when the VSI is up and running. Open the Dash Board and find the cipher text which is your encrypted log message.

Use the `decrypt-basic.sh` along with the private key you generated to decipher the encrypted log message.
   ```
   echo hyper-protect-basic.rdf...EqM | decrypt-basic.sh logging
   ```